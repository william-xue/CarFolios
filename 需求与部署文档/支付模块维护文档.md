# 支付模块维护文档

> 本文档详细介绍车故二手车交易平台的支付功能实现、配置方法和常见问题处理。

---

## 目录

1. [模块概述](#1-模块概述)
2. [技术架构](#2-技术架构)
3. [数据库设计](#3-数据库设计)
4. [支付流程详解](#4-支付流程详解)
5. [环境配置](#5-环境配置)
6. [API 接口文档](#6-api-接口文档)
7. [代码结构](#7-代码结构)
8. [微信支付集成](#8-微信支付集成)
9. [支付宝集成](#9-支付宝集成)
10. [前端集成](#10-前端集成)
11. [常见问题排查](#11-常见问题排查)
12. [测试指南](#12-测试指南)
13. [上线检查清单](#13-上线检查清单)

---

## 1. 模块概述

### 1.1 功能范围

支付模块负责处理平台的订金支付业务，主要功能包括：

- **支付渠道**：微信支付（H5/扫码）、支付宝（手机网站/电脑网站）
- **支付管理**：创建支付订单、查询状态、处理回调
- **退款处理**：全额退款、部分退款
- **超时处理**：自动关闭超时未支付订单
- **统计报表**：支付金额统计、渠道分布

### 1.2 业务规则

| 规则 | 说明 |
|------|------|
| 支付金额 | 订单定金金额，单位：元，内部存储单位：分 |
| 支付有效期 | 30 分钟，超时自动关闭 |
| 重复支付 | 同一订单发起新支付时，自动关闭旧的未完成支付 |
| 退款限制 | 仅已支付订单可退款，退款金额 ≤ 已支付金额 |

---

## 2. 技术架构

### 2.1 技术栈

```
后端：NestJS + Prisma + PostgreSQL
前端：Vue 3 + Vant (Mobile) / Element Plus (Admin)
支付SDK：wechatpay-node-v3、alipay-sdk
定时任务：@nestjs/schedule
```

### 2.2 架构图

```
┌─────────────────────────────────────────────────────────────┐
│                        前端应用                              │
│  ┌─────────────────┐         ┌─────────────────┐           │
│  │   Mobile (H5)   │         │   Admin (PC)    │           │
│  │  - 支付确认页    │         │  - 支付管理列表  │           │
│  │  - 支付结果页    │         │  - 退款操作      │           │
│  └────────┬────────┘         └────────┬────────┘           │
└───────────┼────────────────────────────┼───────────────────┘
            │                            │
            ▼                            ▼
┌─────────────────────────────────────────────────────────────┐
│                     NestJS 后端服务                          │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                 PaymentController                    │   │
│  │  POST /payments/create     - 创建支付订单            │   │
│  │  GET  /payments/:id/status - 查询支付状态            │   │
│  │  POST /payments/:id/refund - 发起退款               │   │
│  └─────────────────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              PaymentCallbackController               │   │
│  │  POST /payments/callback/wechat - 微信支付回调       │   │
│  │  POST /payments/callback/alipay - 支付宝回调         │   │
│  └─────────────────────────────────────────────────────┘   │
│  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐       │
│  │PaymentService│ │WechatPaySvc  │ │ AlipaySvc    │       │
│  └──────────────┘ └──────────────┘ └──────────────┘       │
└─────────────────────────────────────────────────────────────┘
            │                            │
            ▼                            ▼
┌─────────────────────┐    ┌─────────────────────────────────┐
│   PostgreSQL        │    │      第三方支付平台              │
│  - Payment 表       │    │  - 微信支付 API                 │
│  - PaymentLog 表    │    │  - 支付宝 API                   │
└─────────────────────┘    └─────────────────────────────────┘
```

---

## 3. 数据库设计

### 3.1 Payment 表（支付订单）

```prisma
model Payment {
  id             Int          @id @default(autoincrement())
  paymentNo      String       @unique @db.VarChar(32)  // 支付订单号
  orderId        Int                                    // 关联业务订单
  userId         Int                                    // 支付用户
  channel        String       @db.VarChar(20)          // 支付渠道: wechat/alipay
  clientType     String       @db.VarChar(10)          // 客户端类型: h5/pc/app
  amount         Int                                    // 支付金额（分）
  status         String       @default("pending")      // 状态
  channelTradeNo String?      @db.VarChar(64)          // 渠道交易号
  clientIp       String?      @db.VarChar(45)          // 客户端IP
  expireTime     DateTime?                              // 过期时间
  paidAt         DateTime?                              // 支付时间
  closedAt       DateTime?                              // 关闭时间
  refundAmount   Int?         @default(0)              // 已退款金额
  refundReason   String?                                // 退款原因
  refundedAt     DateTime?                              // 退款时间
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
}
```

### 3.2 PaymentLog 表（支付日志）

```prisma
model PaymentLog {
  id           Int      @id @default(autoincrement())
  paymentId    Int                                      // 关联支付订单
  action       String   @db.VarChar(20)                // 操作类型
  status       String   @db.VarChar(20)                // 操作前状态
  newStatus    String?  @db.VarChar(20)                // 操作后状态
  clientIp     String?  @db.VarChar(45)
  requestData  String?  @db.Text                       // 请求数据（脱敏）
  responseData String?  @db.Text                       // 响应数据（脱敏）
  operatorId   Int?                                     // 操作人ID
  createdAt    DateTime @default(now())
}
```

### 3.3 状态流转

```
                    ┌──────────┐
                    │ pending  │ 待支付
                    └────┬─────┘
                         │
          ┌──────────────┼──────────────┐
          │              │              │
          ▼              ▼              ▼
    ┌──────────┐  ┌──────────┐  ┌──────────┐
    │   paid   │  │  closed  │  │  failed  │
    │  已支付   │  │  已关闭   │  │  失败    │
    └────┬─────┘  └──────────┘  └──────────┘
         │
         ▼
    ┌──────────┐
    │ refunded │ 已退款
    └──────────┘
```

**状态说明：**
- `pending`: 待支付，初始状态
- `paid`: 已支付，收到支付成功回调
- `closed`: 已关闭，超时或手动关闭
- `failed`: 支付失败
- `refunded`: 已退款（全额）

---

## 4. 支付流程详解

### 4.1 正常支付流程

```
用户                    前端                    后端                   支付渠道
 │                       │                       │                       │
 │  1. 点击支付           │                       │                       │
 │──────────────────────>│                       │                       │
 │                       │  2. POST /payments/create                     │
 │                       │──────────────────────>│                       │
 │                       │                       │  3. 创建支付订单       │
 │                       │                       │  4. 调用渠道下单API    │
 │                       │                       │──────────────────────>│
 │                       │                       │<──────────────────────│
 │                       │                       │  5. 返回支付参数       │
 │                       │<──────────────────────│                       │
 │  6. 跳转支付页面       │                       │                       │
 │<──────────────────────│                       │                       │
 │                       │                       │                       │
 │  7. 完成支付           │                       │                       │
 │──────────────────────────────────────────────────────────────────────>│
 │                       │                       │                       │
 │                       │                       │  8. 异步回调通知       │
 │                       │                       │<──────────────────────│
 │                       │                       │  9. 验签、更新状态     │
 │                       │                       │  10. 返回 SUCCESS      │
 │                       │                       │──────────────────────>│
 │                       │                       │                       │
 │                       │  11. 轮询支付状态      │                       │
 │                       │──────────────────────>│                       │
 │                       │<──────────────────────│                       │
 │  12. 显示支付结果      │                       │                       │
 │<──────────────────────│                       │                       │
```

### 4.2 关键节点说明

#### 4.2.1 创建支付订单

```typescript
// packages/server/src/modules/payment/payment.service.ts
async createPayment(dto: CreatePaymentDto, userId: number) {
  // 1. 校验业务订单状态（仅 pending 可支付）
  // 2. 关闭该订单的旧支付订单
  // 3. 生成唯一支付订单号（PAY + 时间戳 + 随机数）
  // 4. 创建支付订单记录
  // 5. 调用支付渠道获取支付参数
  // 6. 返回支付参数给前端
}
```

#### 4.2.2 处理支付回调

```typescript
// packages/server/src/modules/payment/payment.service.ts
async handlePaymentSuccess(paymentNo: string, channelTradeNo: string) {
  // 1. 查询支付订单
  // 2. 幂等性检查（已支付直接返回）
  // 3. 状态校验
  // 4. 金额校验
  // 5. 更新支付订单状态为 paid
  // 6. 同步更新业务订单状态
  // 7. 记录回调日志
}
```

#### 4.2.3 超时自动关闭

```typescript
// 定时任务：每分钟执行
@Cron(CronExpression.EVERY_MINUTE)
async handleExpiredPayments() {
  // 查找创建时间超过 30 分钟且状态为 pending 的订单
  // 批量更新状态为 closed
}
```

---

## 5. 环境配置

### 5.1 环境变量配置

在 `packages/server/.env` 文件中配置：

```bash
# ==================== 微信支付配置 ====================
# 微信公众号/小程序 AppID
WECHAT_APP_ID=wx1234567890abcdef

# 微信支付商户号
WECHAT_MCH_ID=1234567890

# API v3 密钥（32位）
WECHAT_API_KEY_V3=your-api-v3-key-32-characters

# 商户私钥（apiclient_key.pem 内容，换行用 \n）
WECHAT_PRIVATE_KEY="-----BEGIN PRIVATE KEY-----\nMIIEvgIBADANBg...\n-----END PRIVATE KEY-----"

# 商户证书序列号
WECHAT_CERT_SERIAL_NO=1234567890ABCDEF1234567890ABCDEF12345678

# 支付回调地址（必须 HTTPS）
WECHAT_NOTIFY_URL=https://your-domain.com/api/payments/callback/wechat

# ==================== 支付宝配置 ====================
# 支付宝应用 AppID
ALIPAY_APP_ID=2021001234567890

# 应用私钥（RSA2）
ALIPAY_PRIVATE_KEY="MIIEvgIBADANBg..."

# 支付宝公钥
ALIPAY_PUBLIC_KEY="MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA..."

# 支付回调地址
ALIPAY_NOTIFY_URL=https://your-domain.com/api/payments/callback/alipay

# 支付成功跳转地址
ALIPAY_RETURN_URL=https://your-domain.com/payment/result
```

### 5.2 配置获取方式

#### 微信支付

1. 登录 [微信支付商户平台](https://pay.weixin.qq.com)
2. 账户中心 → API安全 → 设置 API v3 密钥
3. 账户中心 → API安全 → 申请 API 证书
4. 产品中心 → 开发配置 → 设置支付授权目录

#### 支付宝

1. 登录 [支付宝开放平台](https://open.alipay.com)
2. 控制台 → 应用 → 创建应用
3. 应用详情 → 开发设置 → 接口加签方式 → 设置 RSA2 密钥
4. 应用详情 → 产品绑定 → 绑定手机网站支付

---

## 6. API 接口文档

### 6.1 创建支付订单

```
POST /api/payments/create
Authorization: Bearer <token>
```

**请求参数：**
```json
{
  "orderId": 123,           // 业务订单ID
  "channel": "wechat",      // 支付渠道: wechat | alipay
  "clientType": "h5"        // 客户端类型: h5 | pc | app
}
```

**响应示例：**
```json
{
  "paymentId": 456,
  "paymentNo": "PAY1701234567890123456",
  "channel": "wechat",
  "amount": 100000,         // 金额（分）
  "expireTime": "2024-01-01T12:30:00.000Z",
  "wechatParams": {
    "h5Url": "https://wx.tenpay.com/..."
  }
}
```

### 6.2 查询支付状态

```
GET /api/payments/:id/status
Authorization: Bearer <token>
```

**响应示例：**
```json
{
  "paymentId": 456,
  "paymentNo": "PAY1701234567890123456",
  "status": "paid",
  "paidAt": "2024-01-01T12:05:00.000Z",
  "orderId": 123,
  "orderStatus": "paid"
}
```

### 6.3 发起退款

```
POST /api/payments/:id/refund
Authorization: Bearer <token>
```

**请求参数：**
```json
{
  "amount": 50000,          // 退款金额（分），可选，默认全额
  "reason": "用户申请退款"   // 退款原因
}
```

### 6.4 支付回调（内部）

```
POST /api/payments/callback/wechat   // 微信回调
POST /api/payments/callback/alipay   // 支付宝回调
```

> 回调接口由支付平台调用，无需手动调用

---

## 7. 代码结构

```
packages/server/src/modules/payment/
├── payment.module.ts           # 模块定义
├── payment.controller.ts       # 支付接口控制器
├── payment.service.ts          # 支付业务逻辑（核心）
├── payment-callback.controller.ts  # 回调处理控制器
├── wechat-pay.service.ts       # 微信支付服务
├── alipay.service.ts           # 支付宝服务
├── dto/
│   ├── create-payment.dto.ts   # 创建支付 DTO
│   ├── payment-query.dto.ts    # 查询 DTO
│   └── refund.dto.ts           # 退款 DTO
└── constants/
    ├── payment-channel.ts      # 支付渠道枚举
    └── payment-status.ts       # 支付状态枚举
```

### 7.1 核心文件说明

| 文件 | 职责 |
|------|------|
| `payment.service.ts` | 支付核心业务逻辑，包括创建订单、状态管理、退款等 |
| `wechat-pay.service.ts` | 微信支付 API 封装，签名生成、回调验证 |
| `alipay.service.ts` | 支付宝 API 封装，签名生成、回调验证 |
| `payment-callback.controller.ts` | 处理支付平台的异步回调通知 |

---

## 8. 微信支付集成

### 8.1 支付方式

| 方式 | 场景 | 方法 |
|------|------|------|
| H5 支付 | 手机浏览器 | `createH5Payment()` |
| Native 支付 | PC 扫码 | `createNativePayment()` |

### 8.2 签名算法

微信支付 API v3 使用 SHA256WithRSA 签名：

```typescript
// wechat-pay.service.ts
generateSignature(method: string, url: string, timestamp: string, nonceStr: string, body: string) {
  const message = `${method}\n${url}\n${timestamp}\n${nonceStr}\n${body}\n`
  const sign = crypto.createSign('RSA-SHA256')
  sign.update(message)
  return sign.sign(this.privateKey, 'base64')
}
```

### 8.3 回调验签

```typescript
verifyCallback(headers: any, body: string): boolean {
  // 1. 获取微信平台证书
  // 2. 验证签名
  // 3. 解密回调数据
}
```

### 8.4 常见错误码

| 错误码 | 说明 | 处理方式 |
|--------|------|----------|
| PARAM_ERROR | 参数错误 | 检查请求参数 |
| SIGN_ERROR | 签名错误 | 检查密钥配置 |
| ORDERNOTEXIST | 订单不存在 | 检查订单号 |
| NOTENOUGH | 余额不足 | 提示用户 |

---

## 9. 支付宝集成

### 9.1 支付方式

| 方式 | 场景 | 方法 |
|------|------|------|
| 手机网站支付 | H5 页面 | `createWapPayment()` |
| 电脑网站支付 | PC 页面 | `createPagePayment()` |

### 9.2 签名算法

支付宝使用 RSA2 (SHA256WithRSA) 签名：

```typescript
// alipay.service.ts
generateSign(params: Record<string, string>): string {
  // 1. 参数按 ASCII 排序
  // 2. 拼接成 key=value&key=value 格式
  // 3. 使用私钥进行 RSA2 签名
}
```

### 9.3 回调验签

```typescript
verifyCallback(params: Record<string, string>): boolean {
  // 1. 提取 sign 参数
  // 2. 剩余参数排序拼接
  // 3. 使用支付宝公钥验证签名
}
```

---

## 10. 前端集成

### 10.1 Mobile 端

**文件位置：**
- `packages/mobile/src/views/payment/index.vue` - 支付确认页
- `packages/mobile/src/views/payment/result.vue` - 支付结果页
- `packages/mobile/src/api/payment.ts` - API 封装

**支付流程：**
```typescript
// 1. 调用创建支付接口
const res = await createPayment({ orderId, channel, clientType: 'h5' })

// 2. 根据渠道跳转
if (channel === 'wechat' && res.wechatParams?.h5Url) {
  window.location.href = res.wechatParams.h5Url
} else if (channel === 'alipay' && res.alipayParams?.formHtml) {
  // 提交支付宝表单
}

// 3. 轮询支付状态（每 2 秒）
const pollStatus = setInterval(async () => {
  const status = await getPaymentStatus(paymentId)
  if (status === 'paid') {
    // 跳转结果页
  }
}, 2000)
```

### 10.2 Admin 端

**文件位置：**
- `packages/admin/src/views/payment/list.vue` - 支付管理列表
- `packages/admin/src/api/payment.ts` - API 封装

**功能：**
- 支付订单列表（筛选、搜索）
- 支付详情查看
- 退款操作
- 支付统计

---

## 11. 常见问题排查

### 11.1 支付创建失败

**问题：** 调用创建支付接口返回错误

**排查步骤：**
1. 检查业务订单状态是否为 `pending`
2. 检查用户是否为订单买家
3. 查看服务端日志中的详细错误信息

### 11.2 回调未收到

**问题：** 用户支付成功但订单状态未更新

**排查步骤：**
1. 检查回调 URL 是否正确配置
2. 确认服务器能被外网访问（HTTPS）
3. 查看 PaymentLog 表是否有回调记录
4. 检查防火墙是否放行支付平台 IP

**临时处理：**
```bash
# 手动触发状态同步
POST /api/payments/:id/query
```

### 11.3 签名验证失败

**问题：** 回调签名验证不通过

**排查步骤：**
1. 检查密钥配置是否正确
2. 确认使用的是正确的密钥类型（微信 v3 / 支付宝 RSA2）
3. 检查证书是否过期

### 11.4 退款失败

**问题：** 退款接口返回错误

**排查步骤：**
1. 检查支付订单状态是否为 `paid`
2. 检查退款金额是否超过可退金额
3. 查看支付渠道返回的具体错误信息

---

## 12. 测试指南

### 12.1 本地测试（无真实支付）

由于真实支付需要企业账号和 HTTPS，本地开发可以：

**方法 1：手动模拟支付成功**
```typescript
// 在数据库中直接更新状态
UPDATE "Payment" SET status = 'paid', "paidAt" = NOW() WHERE id = xxx;
UPDATE "Order" SET status = 'paid', "payTime" = NOW() WHERE id = xxx;
```

**方法 2：调用内部方法**
```typescript
// 在 payment.service.ts 中调用
await this.handlePaymentSuccess('PAYxxx', 'TEST_TRADE_NO')
```

### 12.2 沙箱测试

**微信支付沙箱：**
1. 登录商户平台 → 开发配置 → 沙箱环境
2. 获取沙箱密钥
3. 使用沙箱 API 地址

**支付宝沙箱：**
1. 登录开放平台 → 沙箱环境
2. 下载沙箱版支付宝 APP
3. 使用沙箱账号测试

### 12.3 生产环境测试

1. 使用小额订单测试（如 0.01 元）
2. 测试完成后及时退款
3. 检查回调是否正常
4. 验证状态同步

---

## 13. 上线检查清单

### 13.1 配置检查

- [ ] 微信支付商户号已开通
- [ ] 支付宝应用已创建并签约
- [ ] 所有密钥已正确配置到环境变量
- [ ] 回调 URL 已配置为生产环境 HTTPS 地址
- [ ] 支付授权目录已配置

### 13.2 安全检查

- [ ] 密钥未提交到代码仓库
- [ ] 回调接口已实现签名验证
- [ ] 金额校验逻辑已实现
- [ ] 敏感日志已脱敏

### 13.3 功能检查

- [ ] 创建支付订单正常
- [ ] 支付回调能正常接收
- [ ] 订单状态同步正确
- [ ] 退款功能正常
- [ ] 超时关闭任务运行正常

### 13.4 监控告警

- [ ] 配置支付失败告警
- [ ] 配置回调异常告警
- [ ] 配置退款异常告警
- [ ] 定期检查支付日志

---

## 附录

### A. 相关文档链接

- [微信支付 API v3 文档](https://pay.weixin.qq.com/wiki/doc/apiv3/apis/index.shtml)
- [支付宝开放平台文档](https://opendocs.alipay.com/open/203/105285)
- [NestJS 官方文档](https://docs.nestjs.com/)

### B. 联系方式

如有问题，请联系：
- 技术负责人：[待填写]
- 支付对接人：[待填写]

---

*文档版本：1.0*
*最后更新：2024年12月*
