# 车故二手车交易平台 - 部署文档

## 项目概述

车故二手车交易平台是一个完整的二手车交易解决方案，包含三个子项目：

| 项目 | 说明 | 技术栈 | 端口 |
|------|------|--------|------|
| `packages/admin` | PC 管理后台 | Vue 3 + Element Plus | 3001 |
| `packages/mobile` | H5 移动端 | Vue 3 + Vant | 3002 |
| `packages/server` | 后端服务 | NestJS + Prisma + SQLite | 8000 |

---

## 环境要求

- Node.js >= 18.x
- pnpm >= 8.x (推荐) 或 npm >= 9.x
- Git

---

## 快速开始

### 1. 克隆项目

```bash
git clone <repository-url>
cd CarFolios
```

### 2. 安装依赖

```bash
# 安装后端依赖
cd packages/server
pnpm install

# 安装管理端依赖
cd ../admin
pnpm install

# 安装移动端依赖
cd ../mobile
pnpm install
```

### 3. 初始化数据库

```bash
cd packages/server

# 生成 Prisma Client
npx prisma generate

# 创建数据库并同步表结构
npx prisma db push

# 初始化种子数据
npx ts-node prisma/seed.ts
```

### 4. 启动服务

```bash
# 终端1: 启动后端服务
cd packages/server
pnpm run dev

# 终端2: 启动管理端
cd packages/admin
pnpm run dev

# 终端3: 启动移动端
cd packages/mobile
pnpm run dev
```

### 5. 访问地址

| 服务 | 地址 |
|------|------|
| 后端 API | http://localhost:8000/api |
| API 文档 | http://localhost:8000/api/docs |
| 管理后台 | http://localhost:3001 |
| H5 移动端 | http://localhost:3002 |

---

## 默认账号

### 管理后台
- 用户名: `admin`
- 密码: `123456`

### H5 移动端
- 手机号: 任意 11 位手机号
- 验证码: `1234` (开发环境固定验证码)

---

## 项目结构

```
CarFolios/
├── packages/
│   ├── admin/                 # PC 管理后台
│   │   ├── src/
│   │   │   ├── views/         # 页面组件
│   │   │   ├── stores/        # Pinia 状态管理
│   │   │   ├── router/        # 路由配置
│   │   │   ├── mock/          # Mock 数据
│   │   │   ├── types/         # TypeScript 类型
│   │   │   └── utils/         # 工具函数
│   │   └── package.json
│   │
│   ├── mobile/                # H5 移动端
│   │   ├── src/
│   │   │   ├── views/         # 页面组件
│   │   │   ├── stores/        # Pinia 状态管理
│   │   │   ├── router/        # 路由配置
│   │   │   ├── mock/          # Mock 数据
│   │   │   └── types/         # TypeScript 类型
│   │   └── package.json
│   │
│   └── server/                # 后端服务
│       ├── src/
│       │   ├── modules/       # 业务模块
│       │   │   ├── auth/      # 认证模块
│       │   │   ├── user/      # 用户模块
│       │   │   ├── car/       # 车源模块
│       │   │   ├── order/     # 订单模块
│       │   │   ├── upload/    # 上传模块
│       │   │   └── brand/     # 品牌模块
│       │   ├── common/        # 公共模块
│       │   └── prisma/        # 数据库服务
│       ├── prisma/
│       │   ├── schema.prisma  # 数据库模型
│       │   └── seed.ts        # 种子数据
│       └── package.json
│
└── 需求与部署文档/             # 文档目录
```

---

## API 接口说明

### 认证模块 `/api/auth`

| 方法 | 路径 | 说明 |
|------|------|------|
| POST | `/admin/login` | 管理员登录 |
| POST | `/send-code` | 发送验证码 |
| POST | `/user/login` | 用户登录 |
| GET | `/me` | 获取当前用户信息 |

### 用户模块 `/api/users`

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | `/` | 获取用户列表 |
| GET | `/:id` | 获取用户详情 |
| PATCH | `/:id/verify` | 审核用户认证 |
| PATCH | `/:id/status` | 启用/禁用用户 |
| POST | `/auth/submit` | 提交实名认证 |

### 车源模块 `/api/cars`

| 方法 | 路径 | 说明 |
|------|------|------|
| POST | `/` | 发布车源 |
| GET | `/` | 获取车源列表 |
| GET | `/on-sale` | 获取上架车源 |
| GET | `/pending` | 获取待审核车源 |
| GET | `/my` | 获取我的车源 |
| GET | `/:id` | 获取车源详情 |
| PATCH | `/:id` | 更新车源 |
| PATCH | `/:id/audit` | 审核车源 |
| PATCH | `/:id/toggle` | 上架/下架 |
| DELETE | `/:id` | 删除车源 |

### 订单模块 `/api/orders`

| 方法 | 路径 | 说明 |
|------|------|------|
| POST | `/` | 创建订单 |
| GET | `/` | 获取订单列表 |
| GET | `/my/buy` | 我的购买订单 |
| GET | `/my/sell` | 我的出售订单 |
| GET | `/:id` | 获取订单详情 |
| PATCH | `/:id/pay` | 支付订单 |
| PATCH | `/:id/complete` | 完成订单 |
| PATCH | `/:id/cancel` | 取消订单 |
| PATCH | `/:id/refund` | 退款 |

### 上传模块 `/api/upload`

| 方法 | 路径 | 说明 |
|------|------|------|
| POST | `/image` | 上传单张图片 |
| POST | `/images` | 上传多张图片 |

### 品牌模块 `/api/brands`

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | `/` | 获取品牌列表 |
| GET | `/:id/series` | 获取车系列表 |
| POST | `/` | 创建品牌 |
| POST | `/:id/series` | 创建车系 |

---

## 数据库模型

### Admin (管理员)
- id, username, password, nickname, avatar, role, status

### User (用户)
- id, mobile, password, nickname, avatar, realName, idCard, authStatus, balance, status

### Brand (品牌)
- id, name, logo, initial, sort, status

### Series (车系)
- id, brandId, name, sort, status

### Car (车源)
- id, title, ownerId, sourceType, brandId, seriesId, firstRegDate, mileage, displacement, gearbox, emissionStandard, price, status, coverImage, images, ...

### Order (订单)
- id, orderNo, carId, buyerId, sellerId, carTitle, carImage, carPrice, depositAmount, status, ...

### Upload (上传记录)
- id, filename, path, mimetype, size, userId

---

## 生产环境部署

### 1. 构建前端项目

```bash
# 构建管理端
cd packages/admin
pnpm run build

# 构建移动端
cd ../mobile
pnpm run build
```

### 2. 构建后端项目

```bash
cd packages/server
pnpm run build
```

### 3. 配置生产数据库

修改 `packages/server/prisma/schema.prisma`:

```prisma
datasource db {
  provider = "postgresql"  // 或 mysql
  url      = env("DATABASE_URL")
}
```

创建 `.env` 文件:

```env
DATABASE_URL="postgresql://user:password@localhost:5432/car_trading"
JWT_SECRET="your-production-secret-key"
```

### 4. 使用 PM2 部署后端

```bash
npm install -g pm2

cd packages/server
pm2 start dist/main.js --name car-trading-api
```

### 5. Nginx 配置示例

```nginx
# 管理后台
server {
    listen 80;
    server_name admin.example.com;
    
    location / {
        root /var/www/car-trading/admin;
        try_files $uri $uri/ /index.html;
    }
}

# H5 移动端
server {
    listen 80;
    server_name m.example.com;
    
    location / {
        root /var/www/car-trading/mobile;
        try_files $uri $uri/ /index.html;
    }
}

# API 服务
server {
    listen 80;
    server_name api.example.com;
    
    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
    
    location /uploads {
        alias /var/www/car-trading/server/uploads;
    }
}
```

---

## 常见问题

### Q: 数据库初始化失败？
A: 确保已安装 Prisma CLI，运行 `npx prisma generate` 后再执行 `npx prisma db push`

### Q: 前端无法连接后端？
A: 检查后端 CORS 配置，确保允许前端域名访问

### Q: 图片上传失败？
A: 确保 `packages/server/uploads` 目录存在且有写入权限

### Q: 验证码收不到？
A: 开发环境使用固定验证码 `1234`，生产环境需要接入短信服务

---

## 技术支持

如有问题，请联系开发团队。

---

*文档更新时间: 2024年12月*
